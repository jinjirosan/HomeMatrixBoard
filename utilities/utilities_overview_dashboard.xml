<form version="1.1">
  <label>üè† Utilities Monitoring - Overview Dashboard</label>
  <description>Comprehensive monitoring of Heating, Hot Water, Cold Water, and Energy systems</description>
  <!-- Row 1: Current Readings for All Utilities -->
  <!-- Row 2: Heating Valve Status -->
  <!-- Row 3: System Health Overview -->
  <!-- Row 4: 24-Hour Usage Trends (Multi-line Chart) -->
  <!-- Row 5: Flow Rate and Power Monitoring -->
  <!-- Row 6: Temperature Monitoring -->
  <!-- Row 7: Daily Consumption Comparison -->
  <!-- Row 8: Cost Estimation -->
  <!-- Row 9: Anomaly Detection -->
  <!-- Row 10: Leak Detection Summary -->
  <!-- Row 10: Efficiency Metrics -->
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="refresh_token">
      <label>Auto Refresh</label>
      <choice value="30s">30 seconds</choice>
      <choice value="1m">1 minute</choice>
      <choice value="5m">5 minutes</choice>
      <choice value="0">None</choice>
      <default>1m</default>
    </input>
  </fieldset>
  <row>
    <panel>
      <title>üî• Heating System</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:heating
| stats 
    earliest(heat_energy) as start_energy,
    latest(heat_energy) as end_energy
| eval consumption_kwh = (end_energy - start_energy) * 1000
| eval display_value = round(consumption_kwh, 1)
| fields display_value</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[50,100,200,300]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">TODAY'S CONSUMPTION (kWh)</option>
        <option name="unit">kWh</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
        <drilldown>
          <link target="_blank">/app/mdgi/utilities_heating_dashboard?form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>‚ô®Ô∏è Hot Water</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater volume=*
| bucket _time span=1h
| stats earliest(volume) as start_vol, latest(volume) as end_vol by _time
| eval hourly_liters = (end_vol - start_vol) * 1000
| stats sum(hourly_liters) as consumption_liters
| eval display_value = round(consumption_liters, 0)
| fields display_value</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[200,400,600]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">TODAY'S CONSUMPTION (Liters)</option>
        <option name="unit">L</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
        <drilldown>
          <link target="_blank">/app/mdgi/utilities_hotwater_dashboard?form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>üö∞ Cold Water</title>
      <single>
        <search>
          <query>index=utilities sourcetype=elster:coldwater
| stats 
    earliest(current_value) as start_today,
    latest(current_value) as current_reading
| eval liters_today = current_reading - start_today
| eval display_value = round(liters_today, 0)
| fields display_value</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[200,400,600]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">TODAY'S CONSUMPTION (Liters)</option>
        <option name="unit">L</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
        <drilldown>
          <link target="_blank">/app/mdgi/utilities_coldwater_dashboard?form.time_token.earliest=$time_token.earliest$&amp;form.time_token.latest=$time_token.latest$</link>
        </drilldown>
      </single>
    </panel>
    <panel>
      <title>‚ö° Energy Consumption</title>
      <single>
        <search>
          <query>index=summary_utilities sourcetype=energy_metrics
| stats sum(total_power_wh_pulse) as total_energy_wh
| eval kWh = round(total_energy_wh / 1000, 1)
| eval display_value = kWh
| fields display_value</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">all</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[10,20,30,40]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">TODAY'S CONSUMPTION (kWh)</option>
        <option name="unit">kWh</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    <panel>
      <title>‚ö° Energy Monitor</title>
      <single>
        <search>
          <query>index=summary_utilities sourcetype=energy_metrics latest=now
| stats latest(kWh_to_power) as current_power_watts
| eval display_value=round(current_power_watts, 0)
| fields display_value</query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[800,1100,1300]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">POWER (W)</option>
        <option name="unit">W</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">0</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>üîÑ Heating Valve Status</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:heating
| stats 
    latest(power) as current_power,
    latest(flow) as current_flow,
    latest(temp1) as supply_temp,
    latest(temp2) as return_temp
| eval delta_t = round(supply_temp - return_temp, 1)
| eval power_active = if(current_power &gt; 0.5, 1, 0)
| eval flow_active = if(current_flow &gt; 0, 1, 0)
| eval temp_diff_active = if(delta_t &gt; 5, 1, 0)
| eval heating_score = power_active + flow_active + temp_diff_active
| eval valve_status = if(heating_score &gt;= 2, "OPEN", "CLOSED")
| eval status_icon = if(valve_status == "OPEN", "üü¢ OPEN", "‚ö´ CLOSED")
| eval power_indicator = if(power_active == 1, "‚úì Power (" + tostring(round(current_power, 1)) + " kW)", "‚úó Power")
| eval flow_indicator = if(flow_active == 1, "‚úì Flow (" + tostring(round(current_flow, 3)) + " m¬≥/h)", "‚úó Flow")
| eval temp_indicator = if(temp_diff_active == 1, "‚úì Temp Œî (" + tostring(delta_t) + "¬∞C)", "‚úó Temp Œî")
| table status_icon, power_indicator, flow_indicator, temp_indicator
| rename status_icon as "Valve Status", power_indicator as "Power", flow_indicator as "Flow", temp_indicator as "Temperature"</query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">1</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <option name="rowNumbers">false</option>
        <format type="color" field="Valve Status">
          <colorPalette type="expression">case(match(value, "OPEN"), "#65A637", match(value, "CLOSED"), "#999999")</colorPalette>
        </format>
        <format type="color" field="Power">
          <colorPalette type="expression">case(match(value, "‚úì"), "#65A637", match(value, "‚úó"), "#D93F3C")</colorPalette>
        </format>
        <format type="color" field="Flow">
          <colorPalette type="expression">case(match(value, "‚úì"), "#65A637", match(value, "‚úó"), "#D93F3C")</colorPalette>
        </format>
        <format type="color" field="Temperature">
          <colorPalette type="expression">case(match(value, "‚úì"), "#65A637", match(value, "‚úó"), "#D93F3C")</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>System Health Overview</title>
      <table>
        <search>
          <query>| makeresults 
| eval utilities="üî• Heating,‚ô®Ô∏è Hot Water,üö∞ Cold Water,‚ö° Energy"
| makemv delim="," utilities
| mvexpand utilities
| eval sourcetype=case(
    utilities=="üî• Heating", "kamstrup:heating",
    utilities=="‚ô®Ô∏è Hot Water", "kamstrup:hotwater",
    utilities=="üö∞ Cold Water", "elster:coldwater",
    utilities=="‚ö° Energy", "emonpi:energy",
    1=1, "unknown"
  )
| join type=left sourcetype 
    [search index=utilities sourcetype IN (kamstrup:*, elster:*, emonpi:*) earliest=-1h latest=now
    | stats 
        count as message_count,
        latest(_time) as last_seen,
        latest(wifi_rssi) as signal_dbm,
        latest(running_firmware_version) as firmware
        by sourcetype]
| eval time_since=if(isnull(last_seen), 999999, now() - last_seen)
| eval status=case(
    isnull(last_seen), "üî¥ NO DATA",
    time_since &lt; 120, "üü¢ ONLINE",
    time_since &lt; 600, "üü° DELAYED",
    1=1, "üî¥ OFFLINE"
  )
| eval signal_quality=case(
    isnull(signal_dbm), "N/A",
    signal_dbm &gt; -50, "Excellent",
    signal_dbm &gt; -60, "Good",
    signal_dbm &gt; -70, "Fair",
    1=1, "Poor"
  )
| eval message_count=coalesce(message_count, 0)
| eval last_seen_friendly=if(isnull(last_seen), "Never", strftime(last_seen, "%H:%M:%S"))
| eval signal_dbm=if(isnull(signal_dbm), "N/A", tostring(signal_dbm))
| eval firmware=coalesce(firmware, "N/A")
| rename utilities as utility
| table utility, status, message_count, last_seen_friendly, signal_dbm, signal_quality, firmware</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="status">
          <colorPalette type="map">{"üü¢ ONLINE": #65A637, "üü° DELAYED": #F7BC38, "üî¥ OFFLINE": #D93F3C}</colorPalette>
        </format>
        <format type="color" field="signal_quality">
          <colorPalette type="map">{"Excellent": #65A637, "Good": #6DB7C6, "Fair": #F7BC38, "Poor": #D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>üìà 24-Hour Activity Intensity (Normalized to Max)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:hotwater, elster:coldwater, kamstrup:heating)
| eval utility=case(
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="elster:coldwater", "Cold Water",
    sourcetype=="kamstrup:heating", "Heating",
    1=1, "Unknown"
  )
| eval activity_rate=case(
    utility=="Heating" AND isnotnull(power), power,
    utility=="Heating" AND isnotnull(flow), flow * 1000,
    utility=="Hot Water" AND isnotnull(flow), flow * 1000,
    utility=="Cold Water" AND isnotnull(water_used_last_minute), water_used_last_minute * 60,
    utility=="Cold Water" AND isnotnull(flow_rate), flow_rate,
    1=1, 0
  )
| bucket _time span=1h
| stats avg(activity_rate) as avg_rate by _time, utility
| eventstats max(avg_rate) as max_rate by utility
| eval activity_intensity = if(max_rate &gt; 0, (avg_rate / max_rate) * 100, 0)
| eval activity_intensity = round(activity_intensity, 1)
| timechart span=1h 
    avg(eval(if(utility=="Heating", activity_intensity, null))) as "Heating",
    avg(eval(if(utility=="Hot Water", activity_intensity, null))) as "Hot Water",
    avg(eval(if(utility=="Cold Water", activity_intensity, null))) as "Cold Water"</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleX.visibility">visible</option>
        <option name="charting.axisTitleY.text">Activity Intensity (% of Max)</option>
        <option name="charting.axisTitleY.visibility">visible</option>
        <option name="charting.axisTitleY2.visibility">visible</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.fieldColors">{"Heating": 0xFF5722, "Hot Water": 0x2196F3, "Cold Water": 0x00BCD4}</option>
        <option name="charting.legend.placement">right</option>
        <option name="charting.lineWidth">3</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>üí® Real-Time Flow Rates (L/h)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:heating, kamstrup:hotwater, elster:coldwater)
| eval flow_lph=case(
    sourcetype=="kamstrup:heating" AND isnotnull(flow), flow * 1000,
    sourcetype=="kamstrup:hotwater" AND isnotnull(flow), flow * 1000,
    sourcetype=="elster:coldwater" AND isnotnull(water_used_last_minute), water_used_last_minute * 60,
    1=1, null()
  )
| eval utility=case(
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="elster:coldwater", "Cold Water",
    sourcetype=="kamstrup:heating", "Heating",
    1=1, "Unknown"
  )
| timechart span=10m avg(flow_lph) as avg_flow by utility</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Flow Rate (L/h)</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.lineWidth">3</option>
        <option name="charting.fieldColors">{"Hot Water": 0xFF9800, "Cold Water": 0x03A9F4, "Heating": 0xF44336}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>‚ö° Power Consumption (kW)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:heating, kamstrup:hotwater)
| eval utility=case(
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="kamstrup:heating", "Heating",
    1=1, "Unknown"
  )
| timechart span=10m avg(power) as avg_power by utility</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Power (kW)</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.fieldColors">{"Hot Water": 0xFFC107, "Heating": 0xFF5722}</option>
        <option name="charting.areaFillOpacity">0.4</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>üå°Ô∏è Temperature Monitoring (Kamstrup Systems)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:*) (temp1=* OR temp2=*)
| eval utility=case(
    sourcetype=="kamstrup:heating", "Heating",
    sourcetype=="kamstrup:hotwater", "Hot Water",
    1=1, "Unknown"
  )
| eval temp_type_supply=utility + " Supply"
| eval temp_type_return=utility + " Return"
| eval temps=mvappend(temp_type_supply + "=" + tostring(temp1), temp_type_return + "=" + tostring(temp2))
| mvexpand temps
| rex field=temps "(?&lt;temp_label&gt;.+)=(?&lt;temp_value&gt;.+)"
| timechart span=15m avg(eval(tonumber(temp_value))) as avg_temp by temp_label</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Temperature (¬∞C)</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.fieldColors">{"Heating Supply": 0xE91E63, "Heating Return": 0x9C27B0, "Hot Water Supply": 0xFF9800, "Hot Water Return": 0xFF5722}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>üìä Daily Consumption Comparison (Last 7 Days)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:hotwater, kamstrup:heating, elster:coldwater)
    (volume=* OR heat_energy=* OR current_value=*)
| bucket _time span=1h
| stats
    earliest(volume) as v_s, latest(volume) as v_e,
    earliest(heat_energy) as h_s, latest(heat_energy) as h_e,
    earliest(current_value) as c_s, latest(current_value) as c_e
    by _time, sourcetype
| eval consumption=case(
    sourcetype=="kamstrup:hotwater", (v_e - v_s) * 1000,
    sourcetype=="kamstrup:heating", (h_e - h_s) * 1000,
    sourcetype=="elster:coldwater", c_e - c_s,
    1=1, 0
  )
| eval utility=case(
    sourcetype=="kamstrup:heating", "Heating",
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="elster:coldwater", "Cold Water",
    1=1, "Other"
  )
| bucket _time span=1d
| stats sum(consumption) as daily_consumption by _time, utility
| eval date=strftime(_time, "%m/%d")
| chart sum(daily_consumption) as consumption over date by utility</query>
          <earliest>-7d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Daily Consumption</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.chart.stackMode">default</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Heating": 0xF44336, "Hot Water": 0x2196F3, "Cold Water": 0x00BCD4}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  <row>
    <panel>
      <title>üí∞ Estimated Daily Costs (Last 7 Days)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:*, elster:*)
    earliest=-7d latest=now
| eval utility=case(
    sourcetype=="kamstrup:heating", "Heating",
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="elster:coldwater", "Cold Water",
    1=1, "Other"
  )
| eval usage=coalesce(heat_energy, volume, current_value, pulse_count, power)
| eval estimated_cost=case(
    utility=="Heating" AND isnotnull(heat_energy), heat_energy * 100,
    utility=="Hot Water" AND isnotnull(volume), volume * 0.08,
    utility=="Cold Water" AND isnotnull(current_value), current_value * 0.000005,
    1=1, 0
  )
| timechart span=1d sum(estimated_cost) as daily_cost by utility</query>
          <earliest>-7d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Cost ($)</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">minmax</option>
        <option name="charting.chart.stackMode">stacked</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"Heating": 0x4CAF50, "Hot Water": 0x2196F3, "Cold Water": 0x00BCD4}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    <panel>
      <title>üíµ Total Estimated Cost (Last 30 Days)</title>
      <single>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:*, elster:*)
    earliest=-30d latest=now
| eval utility=case(
    sourcetype=="kamstrup:heating", "Heating",
    sourcetype=="kamstrup:hotwater", "Hot Water",
    sourcetype=="elster:coldwater", "Cold Water",
    1=1, "Other"
  )
| eval usage=coalesce(heat_energy, volume, current_value, pulse_count)
| eval estimated_cost=case(
    utility=="Heating" AND isnotnull(heat_energy), heat_energy * 100,
    utility=="Hot Water" AND isnotnull(volume), volume * 0.08,
    utility=="Cold Water" AND isnotnull(current_value), current_value * 0.000005,
    1=1, 0
  )
| stats sum(estimated_cost) as total_cost
| eval total_cost=round(total_cost, 2)</query>
          <earliest>-30d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.01</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[50,100,150,200]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">30-DAY TOTAL</option>
        <option name="unit">$</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  <row>
    <panel>
      <title>‚ö†Ô∏è Anomaly Detection - High Flow/Power Alerts</title>
      <table>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:heating, kamstrup:hotwater, elster:coldwater)
| eval flow_metric=case(
    sourcetype=="kamstrup:heating" AND isnotnull(flow), flow * 1000,
    sourcetype=="kamstrup:hotwater" AND isnotnull(flow), flow * 1000,
    sourcetype=="elster:coldwater" AND isnotnull(water_used_last_minute), water_used_last_minute * 60,
    isnotnull(power), power * 100,
    1=1, null()
  )
| eval utility=case(
    sourcetype=="kamstrup:hotwater", "‚ô®Ô∏è Hot Water",
    sourcetype=="elster:coldwater", "üö∞ Cold Water",
    sourcetype=="kamstrup:heating", "üî• Heating",
    1=1, "Unknown"
  )
| stats 
    avg(flow_metric) as avg_flow,
    max(flow_metric) as max_flow,
    stdev(flow_metric) as stdev_flow,
    count as sample_count
    by utility
| eval threshold=avg_flow + (2 * stdev_flow)
| eval alert_level=case(
    max_flow &gt; threshold, "‚ö†Ô∏è ELEVATED",
    max_flow &gt; (threshold * 0.75), "‚ö° ELEVATED",
    1=1, "‚úÖ NORMAL"
  )
| table utility, avg_flow, max_flow, threshold, alert_level, sample_count
| eval avg_flow=round(avg_flow, 1), max_flow=round(max_flow, 1), threshold=round(threshold, 1)
| sort - max_flow</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>1m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="alert_level">
          <colorPalette type="map">{"‚úÖ NORMAL": #65A637, "‚ö° ELEVATED": #F7BC38, "‚ö†Ô∏è HIGH": #D93F3C}</colorPalette>
        </format>
        <format type="number" field="avg_flow">
          <option name="precision">1</option>
        </format>
        <format type="number" field="max_flow">
          <option name="precision">1</option>
        </format>
        <format type="number" field="threshold">
          <option name="precision">1</option>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>üö® Leak Detection Status (All Systems)</title>
      <table>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:heating, kamstrup:hotwater, elster:coldwater)
| eval utility=case(
    sourcetype=="kamstrup:heating", "üî• Heating",
    sourcetype=="kamstrup:hotwater", "‚ô®Ô∏è Hot Water",
    sourcetype=="elster:coldwater", "üö∞ Cold Water",
    1=1, "Unknown"
  )
| eval leak_value=coalesce(leak_burst, leak_detect)
| eval leak_type=case(
    isnotnull(leak_burst), "Burst/Leak",
    isnotnull(leak_detect), "Flow Anomaly",
    1=1, "Unknown"
  )
| stats 
    latest(leak_value) as current_status,
    count(eval(leak_value=1)) as total_leak_events,
    latest(_time) as last_check
    by utility, leak_type
| eval status=case(
    current_status=0, "‚úÖ NO LEAK",
    current_status=1, "üî¥ LEAK DETECTED",
    1=1, "‚ùì UNKNOWN"
  )
| eval last_check_time=strftime(last_check, "%Y-%m-%d %H:%M")
| table utility, leak_type, status, total_leak_events, last_check_time
| sort utility</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="status">
          <colorPalette type="map">{"‚úÖ NO LEAK": #65A637, "üî¥ LEAK DETECTED": #D93F3C, "‚ùì UNKNOWN": #6DB7C6}</colorPalette>
        </format>
      </table>
    </panel>
    <panel>
      <title>üìä System Event Summary (Last Hour)</title>
      <table>
        <search>
          <query>index=utilities sourcetype IN (kamstrup:*, elster:*, emonpi:energy)
| eval utility=case(
    sourcetype=="kamstrup:heating", "üî• Heating",
    sourcetype=="kamstrup:hotwater", "‚ô®Ô∏è Hot Water",
    sourcetype=="elster:coldwater", "üö∞ Cold Water",
    sourcetype=="emonpi:energy", "‚ö° Energy",
    1=1, "Other"
  )
| stats 
    count as total_events,
    dc(mqtt_topic) as unique_topics,
    earliest(_time) as first_event,
    latest(_time) as last_event
    by utility
| eval data_rate=round(total_events / 60, 1)
| eval first_event_time=strftime(first_event, "%H:%M:%S")
| eval last_event_time=strftime(last_event, "%H:%M:%S")
| table utility, total_events, data_rate, unique_topics, first_event_time, last_event_time
| sort - total_events</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">10</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="number" field="total_events">
          <option name="precision">0</option>
        </format>
        <format type="number" field="data_rate">
          <option name="precision">1</option>
          <option name="unit">events/min</option>
        </format>
      </table>
    </panel>
  </row>
  <row>
    <panel>
      <title>‚≠ê Heating Efficiency (Energy per Volume)</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:heating
| stats 
    latest(heat_energy) as energy_mwh,
    latest(volume) as volume_m3
| eval efficiency=if(volume_m3 &gt; 0, (energy_mwh * 1000) / volume_m3, 0)
| eval efficiency=round(efficiency, 2)
| fields efficiency</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.01</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[20,40,60]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">kWh per m¬≥</option>
        <option name="unit">kWh/m¬≥</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>üìà Data Ingestion Rate</title>
      <single>
        <search>
          <query>index=utilities earliest=-1h
| stats count as events_last_hour
| eval events_per_minute=round(events_last_hour / 60, 1)
| fields events_per_minute</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0xD93F3C","0xF7BC38","0x65A637"]</option>
        <option name="rangeValues">[5,10]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">EVENTS PER MINUTE</option>
        <option name="unit">evt/min</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>üîå Active Gateways</title>
      <single>
        <search>
          <query>index=utilities earliest=-15m 
| stats dc(source) as gateway_count
| fields gateway_count</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0xD93F3C","0xF7BC38","0x6DB7C6","0x65A637"]</option>
        <option name="rangeValues">[1,2,3]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">GATEWAYS ONLINE</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    <panel>
      <title>üì° Average Signal Strength</title>
      <single>
        <search>
          <query>index=utilities
| stats avg(wifi_rssi) as avg_signal
| eval avg_signal=round(avg_signal, 0)
| fields avg_signal</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0</option>
        <option name="rangeColors">["0xD93F3C","0xF7BC38","0x6DB7C6","0x65A637"]</option>
        <option name="rangeValues">[-70,-60,-50]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">WIFI SIGNAL (dBm)</option>
        <option name="unit">dBm</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
</form>