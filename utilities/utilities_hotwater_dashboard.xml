<form version="1.1">
  <label>â™¨ï¸ Hot Water Consumption Dashboard</label>
  <description>Real-time monitoring of Kamstrup 2200IQ hot water system - Volume, Flow, and Meter Temperature</description>
  <fieldset submitButton="false" autoRun="true">
    <input type="time" token="time_token">
      <label>Time Range</label>
      <default>
        <earliest>-24h@h</earliest>
        <latest>now</latest>
      </default>
    </input>
    <input type="dropdown" token="refresh_token">
      <label>Auto Refresh</label>
      <choice value="30s">30 seconds</choice>
      <choice value="1m">1 minute</choice>
      <choice value="5m">5 minutes</choice>
      <choice value="0">None</choice>
      <default>1m</default>
    </input>
  </fieldset>
  
  <!-- Row 1: Key Metrics -->
  <row>
    <panel>
      <title>Today's Consumption</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater volume=*
| bucket _time span=1h
| stats earliest(volume) as start_vol, latest(volume) as end_vol by _time
| eval hourly_liters = (end_vol - start_vol) * 1000
| stats sum(hourly_liters) as consumption_liters
| eval consumption_liters = round(consumption_liters, 1)
| fields consumption_liters</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[150,250,350,450]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">LITERS TODAY</option>
        <option name="unit">L</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
    
    <panel>
      <title>Current Flow Rate</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater flow=*
| stats latest(flow) as flow_lph
| eval flow_lpm = flow_lph / 60
| eval flow_lpm = round(flow_lpm, 2)
| fields flow_lpm</query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.01</option>
        <option name="rangeColors">["0x6DB7C6","0x65A637","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[0.1,2,5,8]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">L/MIN (LIVE)</option>
        <option name="unit">L/min</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    
    <panel>
      <title>Meter Temperature</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater meter_temp=*
| stats latest(meter_temp) as meter_temp
| eval meter_temp = round(meter_temp, 1)
| fields meter_temp</query>
          <earliest>-5m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0xD93F3C","0xF7BC38","0x65A637","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">[0,10,20,30]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">METER HOUSING (Â°C)</option>
        <option name="unit">Â°C</option>
        <option name="useColors">1</option>
      </single>
    </panel>
    
  </row>
  
  <!-- Row 2: Flow Rate Timeline -->
  <row>
    <panel>
      <title>ğŸ“ˆ Flow Rate Timeline (Last 24 Hours)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater flow=*
| eval flow_lpm = flow / 60
| timechart span=5m avg(flow_lpm) as avg_flow_lpm
| eval avg_flow_lpm = round(avg_flow_lpm, 2)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Flow Rate (L/min)</option>
        <option name="charting.chart">area</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.fieldColors">{"avg_flow_lpm": 0x2196F3}</option>
        <option name="charting.areaFillOpacity">0.5</option>
        <option name="charting.lineWidth">2</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  
  <!-- Row 3: Meter Temperature Monitoring -->
  <row>
    <panel>
      <title>ğŸŒ¡ï¸ Meter Temperature Timeline</title>
      <chart>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater meter_temp=*
| timechart span=10m avg(meter_temp) as "Meter Temp (Â°C)"
| eval "Meter Temp (Â°C)" = round('Meter Temp (Â°C)', 1)</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Time</option>
        <option name="charting.axisTitleY.text">Temperature (Â°C)</option>
        <option name="charting.chart">line</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.lineWidth">2</option>
        <option name="charting.fieldColors">{"Meter Temp (Â°C)": 0x4CAF50}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  
  <!-- Row 4: Daily Consumption -->
  <row>
    <panel>
      <title>ğŸ“Š Daily Hot Water Consumption (Last 30 Days)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater volume=*
    earliest=-30d latest=now
| bucket _time span=1h
| stats earliest(volume) as start_vol, latest(volume) as end_vol by _time
| eval hourly_liters = (end_vol - start_vol) * 1000
| bucket _time span=1d
| stats sum(hourly_liters) as daily_liters by _time
| eval date = strftime(_time, "%m/%d")
| table date, daily_liters
| eval daily_liters = round(daily_liters, 0)</query>
          <earliest>-30d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Consumption (Liters)</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.fieldColors">{"daily_liters": 0x00BCD4}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  
  <!-- Row 5: Hourly Breakdown and Weekly Comparison -->
  <row>
    <panel>
      <title>â° Hourly Usage Breakdown (Today)</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater volume=*
    earliest=@d latest=now
| bucket _time span=1h
| stats 
    earliest(volume) as start_vol,
    latest(volume) as end_vol
    by _time
| eval hourly_liters = (end_vol - start_vol) * 1000
| eval hour = strftime(_time, "%H:00")
| eval usage_level = case(
    isnull(hourly_liters) OR hourly_liters &lt; 0, "No data",
    hourly_liters &lt; 10, "Low",
    hourly_liters &lt; 30, "Normal",
    hourly_liters &lt; 60, "High",
    1=1, "Very High"
)
| table hour, hourly_liters, usage_level
| eval hourly_liters = round(coalesce(hourly_liters, 0), 1)
| sort hour</query>
          <earliest>@d</earliest>
          <latest>now</latest>
          <refresh>5m</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">24</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="usage_level">
          <colorPalette type="map">{"No data": #999999, "Low": #6DB7C6, "Normal": #65A637, "High": #F7BC38, "Very High": #D93F3C}</colorPalette>
        </format>
        <format type="number" field="hourly_liters">
          <option name="precision">1</option>
          <option name="unit">L</option>
        </format>
      </table>
    </panel>
    
    <panel>
      <title>ğŸ“… Weekly Comparison</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater volume=*
    earliest=-14d latest=now
| eval week = if(_time &gt;= relative_time(now(), "-7d@d"), "This Week", "Last Week")
| bucket _time span=1d
| stats 
    earliest(volume) as start_vol,
    latest(volume) as end_vol
    by _time, week
| eval daily_liters = (end_vol - start_vol) * 1000
| stats sum(daily_liters) as total_consumption by week
| eval total_consumption = round(total_consumption, 0)
| sort - week</query>
          <earliest>-14d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">5</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="number" field="total_consumption">
          <option name="precision">0</option>
          <option name="unit">L</option>
        </format>
      </table>
    </panel>
  </row>
  
  <!-- Row 6: Peak Usage Analysis -->
  <row>
    <panel>
      <title>ğŸ”¥ Peak Usage Times by Hour</title>
      <chart>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater flow=*
| eval hour = strftime(_time, "%H")
| eval flow_lpm = flow / 60
| stats 
    avg(flow_lpm) as avg_flow,
    max(flow_lpm) as max_flow
    by hour
| eval avg_flow = round(avg_flow, 2)
| eval max_flow = round(max_flow, 2)
| sort hour</query>
          <earliest>$time_token.earliest$</earliest>
          <latest>$time_token.latest$</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Hour of Day</option>
        <option name="charting.axisTitleY.text">Flow Rate (L/min)</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">none</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">bottom</option>
        <option name="charting.fieldColors">{"avg_flow": 0x4CAF50, "max_flow": 0xFF5722}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
  </row>
  
  <!-- Row 7: Efficiency -->
  <row>
    <panel>
      <title>â­ Efficiency Score</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater (heat_energy=* AND volume=*)
| stats 
    latest(heat_energy) as total_energy_mwh,
    latest(volume) as total_volume_m3
| eval energy_kwh = total_energy_mwh * 1000
| eval efficiency_kwh_per_m3 = energy_kwh / total_volume_m3
| eval efficiency_kwh_per_m3 = round(efficiency_kwh_per_m3, 1)
| fields efficiency_kwh_per_m3</query>
          <earliest>-30d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.1</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[40,55,70,85]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">kWh per mÂ³ (30-day)</option>
        <option name="unit">kWh/mÂ³</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  
  <!-- Row 8: Leak Detection and Alerts -->
  <row>
    <panel>
      <title>ğŸš¨ Continuous Flow Detection (Potential Leak)</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater flow=*
    earliest=-2h latest=now
| eval flow_lpm = flow / 60
| stats 
    count(eval(flow_lpm &gt; 0.5)) as minutes_flowing,
    latest(flow_lpm) as current_flow
| eval alert_status = case(
    minutes_flowing &gt; 90, "ğŸ”´ Investigate - Leak Suspected",
    minutes_flowing &gt; 60, "ğŸŸ¡ Extended Flow - Monitor",
    minutes_flowing &gt; 30, "âš ï¸ Long Usage",
    1=1, "âœ… Normal"
)
| eval duration_minutes = minutes_flowing
| eval current_flow = round(current_flow, 2)
| table alert_status, duration_minutes, current_flow</query>
          <earliest>-2h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">5</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="alert_status">
          <colorPalette type="map">{"âœ… Normal": #65A637, "âš ï¸ Long Usage": #F7BC38, "ğŸŸ¡ Extended Flow - Monitor": #F58F39, "ğŸ”´ Investigate - Leak Suspected": #D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
    
    <panel>
      <title>ğŸŒ¡ï¸ Meter Temperature Status</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater meter_temp=*
| stats 
    latest(meter_temp) as current_temp,
    min(meter_temp) as min_temp,
    max(meter_temp) as max_temp,
    avg(meter_temp) as avg_temp
| eval current_temp = round(current_temp, 1)
| eval min_temp = round(min_temp, 1)
| eval max_temp = round(max_temp, 1)
| eval avg_temp = round(avg_temp, 1)
| table current_temp, avg_temp, min_temp, max_temp</query>
          <earliest>-24h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">5</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="number" field="current_temp">
          <option name="precision">1</option>
          <option name="unit">Â°C</option>
        </format>
        <format type="number" field="avg_temp">
          <option name="precision">1</option>
          <option name="unit">Â°C</option>
        </format>
        <format type="number" field="min_temp">
          <option name="precision">1</option>
          <option name="unit">Â°C</option>
        </format>
        <format type="number" field="max_temp">
          <option name="precision">1</option>
          <option name="unit">Â°C</option>
        </format>
      </table>
    </panel>
  </row>
  
  <!-- Row 9: Cost Estimation -->
  <row>
    <panel>
      <title>ğŸ’° Daily Energy Cost Estimate (Last 7 Days)</title>
      <chart>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater heat_energy=*
    earliest=-7d latest=now
| bucket _time span=1d
| stats 
    earliest(heat_energy) as start_energy,
    latest(heat_energy) as end_energy
    by _time
| eval daily_kwh = (end_energy - start_energy) * 1000
| eval daily_cost = daily_kwh * 0.15
| eval date = strftime(_time, "%m/%d")
| table date, daily_cost
| eval daily_cost = round(daily_cost, 2)</query>
          <earliest>-7d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="charting.axisTitleX.text">Date</option>
        <option name="charting.axisTitleY.text">Cost ($)</option>
        <option name="charting.chart">column</option>
        <option name="charting.chart.showDataLabels">all</option>
        <option name="charting.drilldown">none</option>
        <option name="charting.legend.placement">none</option>
        <option name="charting.fieldColors">{"daily_cost": 0x4CAF50}</option>
        <option name="refresh.display">progressbar</option>
      </chart>
    </panel>
    
    <panel>
      <title>ğŸ’µ Estimated Monthly Cost</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater heat_energy=*
    earliest=-30d latest=now
| bucket _time span=1d
| stats 
    earliest(heat_energy) as start_energy,
    latest(heat_energy) as end_energy
    by _time
| eval daily_kwh = (end_energy - start_energy) * 1000
| eval daily_cost = daily_kwh * 0.15
| stats sum(daily_cost) as monthly_cost
| eval monthly_cost = round(monthly_cost, 2)
| fields monthly_cost</query>
          <earliest>-30d</earliest>
          <latest>now</latest>
          <refresh>1h</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="numberPrecision">0.01</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xF58F39","0xD93F3C"]</option>
        <option name="rangeValues">[20,40,60,80]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">30-DAY ESTIMATE ($0.15/kWh)</option>
        <option name="unit">$</option>
        <option name="useColors">1</option>
        <option name="useThousandSeparators">1</option>
      </single>
    </panel>
  </row>
  
  <!-- Row 10: System Status -->
  <row>
    <panel>
      <title>ğŸ”Œ Gateway Status</title>
      <table>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater
| stats 
    count as total_events,
    latest(_time) as last_seen,
    latest(wifi_rssi) as signal_dbm,
    latest(running_firmware_version) as firmware
| eval last_seen_time = strftime(last_seen, "%H:%M:%S")
| eval time_since = now() - last_seen
| eval status = case(
    time_since &lt; 120, "ğŸŸ¢ ONLINE",
    time_since &lt; 600, "ğŸŸ¡ DELAYED",
    1=1, "ğŸ”´ OFFLINE"
)
| eval signal_quality = case(
    signal_dbm &gt; -50, "Excellent",
    signal_dbm &gt; -60, "Good",
    signal_dbm &gt; -70, "Fair",
    1=1, "Poor"
)
| table status, total_events, last_seen_time, signal_dbm, signal_quality, firmware</query>
          <earliest>-1h</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="count">5</option>
        <option name="drilldown">none</option>
        <option name="refresh.display">progressbar</option>
        <format type="color" field="status">
          <colorPalette type="map">{"ğŸŸ¢ ONLINE": #65A637, "ğŸŸ¡ DELAYED": #F7BC38, "ğŸ”´ OFFLINE": #D93F3C}</colorPalette>
        </format>
        <format type="color" field="signal_quality">
          <colorPalette type="map">{"Excellent": #65A637, "Good": #6DB7C6, "Fair": #F7BC38, "Poor": #D93F3C}</colorPalette>
        </format>
      </table>
    </panel>
    
    <panel>
      <title>âœ… Data Freshness</title>
      <single>
        <search>
          <query>index=utilities sourcetype=kamstrup:hotwater
| stats latest(_time) as last_event
| eval seconds_ago = now() - last_event
| eval status = case(
    seconds_ago &lt; 60, "Current",
    seconds_ago &lt; 300, "Recent",
    seconds_ago &lt; 600, "Delayed",
    1=1, "Stale"
)
| eval seconds_ago = round(seconds_ago, 0)
| fields status</query>
          <earliest>-15m</earliest>
          <latest>now</latest>
          <refresh>$refresh_token$</refresh>
          <refreshType>delay</refreshType>
        </search>
        <option name="drilldown">none</option>
        <option name="rangeColors">["0x65A637","0x6DB7C6","0xF7BC38","0xD93F3C"]</option>
        <option name="rangeValues">["Recent","Delayed","Stale"]</option>
        <option name="refresh.display">progressbar</option>
        <option name="underLabel">DATA STATUS</option>
        <option name="useColors">1</option>
      </single>
    </panel>
  </row>
  
</form>

